name: Notify Code Owners and Request Reviews

on:
  pull_request:
    types: [opened, synchronize] 

jobs:
  notify-and-request-reviews:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Determine Changed Files
        id: changed-files
        run: |
          newline=$'\n' # Store newline for better readability        
          echo "::set-output name=changed_files::$(git diff --name-only ${{ github.event.before }} ${{ github.event.pull_request.head.sha }} | jq -R -s 'split("'"$newline"'") | .[:-1]')"

      - name: Notify Code Owners and Request Reviews
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          changed_files=(${{ steps.changed-files.outputs.changed_files }})
          if [ -f CODEOWNERS ]; then
            # Optimized pattern matching using grep -f
            codeowners=$(grep -f <(echo "${changed_files[@]}" | tr ' ' '\n') CODEOWNERS | cut -d ' ' -f 2 | uniq) 

            if [[ -n "$codeowners" ]]; then # More explicit check
              pr_number=$(jq --raw-output .pull_request.number "$GITHUB_EVENT_PATH")
              message="Please review the changes: @$codeowners" # Combine for a single API call

              curl -s -H "Authorization: token $GITHUB_TOKEN" -X POST -d "{\"body\": \"$message\"}" "https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/${pr_number}/comments"

              curl -s -H "Authorization: token $GITHUB_TOKEN" -X POST -d "{\"reviewers\": $codeowners}" "https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls/${pr_number}/requested_reviewers"
            fi
          fi 